<div class="payment-management-container p-6 bg-gray-50 min-h-screen">
  <!-- Header Section -->
  <div class="mb-6">
    <div class="flex justify-between items-center mb-4">
      <h1 class="text-3xl font-bold text-gray-800">إدارة المدفوعات</h1>
      <div class="flex gap-3">
        <button 
          (click)="toggleStatsCards()" 
          class="bg-gray-600 hover:bg-gray-700 text-white px-6 py-2 rounded-lg flex items-center gap-2 transition-colors">
          <i class="fas" [class.fa-eye]="!showStatsCards" [class.fa-eye-slash]="showStatsCards"></i>
          {{ showStatsCards ? 'إخفاء الإحصائيات' : 'إظهار الإحصائيات' }}
        </button>
        <button 
          (click)="openReportsModal()" 
          class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded-lg flex items-center gap-2 transition-colors">
          <i class="fas fa-chart-bar"></i>
          التقارير
        </button>
        <button 
          (click)="openPaymentModal()" 
          class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg flex items-center gap-2 transition-colors">
          <i class="fas fa-plus"></i>
          إضافة دفعة جديدة
        </button>
      </div>
    </div>

    <!-- Statistics Cards -->
    <div *ngIf="showStatsCards" class="mb-6">
      <!-- Statistics Period Header -->
      <div class="mb-4 p-3 bg-blue-50 border border-blue-200 rounded-lg">
        <div class="flex items-center justify-between">
          <div class="flex items-center gap-2">
            <i class="fas fa-calendar-alt text-blue-600"></i>
            <span class="text-sm font-medium text-blue-800">فترة الإحصائيات:</span>
            <span class="text-sm text-blue-700 font-semibold">{{ statsDateRange.description }}</span>
          </div>
          <div class="text-xs text-blue-600">
            <i class="fas fa-info-circle"></i>
            الإحصائيات محسوبة بناءً على الفلاتر المطبقة
          </div>
        </div>
      </div>
      
      <!-- Statistics Cards Grid -->
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4">
      <div class="bg-gradient-to-r from-blue-50 to-blue-100 p-4 rounded-lg shadow-md border border-blue-200">
        <div class="flex items-center">
          <div class="p-2 bg-blue-500 rounded-lg">
            <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
            </svg>
          </div>
          <div class="mr-4">
            <div class="text-sm text-gray-600">إجمالي المدفوعات</div>
            <div class="text-2xl font-bold text-gray-900">{{ paymentStats.totalPayments }}</div>
          </div>
        </div>
      </div>
      <div class="bg-gradient-to-r from-indigo-50 to-indigo-100 p-4 rounded-lg shadow-md border border-indigo-200">
        <div class="flex items-center">
          <div class="p-2 bg-indigo-500 rounded-lg">
            <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1"></path>
            </svg>
          </div>
          <div class="mr-4">
            <div class="text-sm text-gray-600">إجمالي المبلغ</div>
            <div class="text-2xl font-bold text-indigo-600">{{ formatCurrency(paymentStats.totalAmount) }}</div>
          </div>
        </div>
      </div>
      <div class="bg-gradient-to-r from-green-50 to-green-100 p-4 rounded-lg shadow-md border border-green-200">
        <div class="flex items-center">
          <div class="p-2 bg-green-500 rounded-lg">
            <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
            </svg>
          </div>
          <div class="mr-4">
            <div class="text-sm text-gray-600">المبلغ المدفوع</div>
            <div class="text-2xl font-bold text-green-600">{{ formatCurrency(paymentStats.paidAmount) }}</div>
          </div>
        </div>
      </div>
      <div class="bg-gradient-to-r from-orange-50 to-orange-100 p-4 rounded-lg shadow-md border border-orange-200">
        <div class="flex items-center">
          <div class="p-2 bg-orange-500 rounded-lg">
            <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
          </div>
          <div class="mr-4">
            <div class="text-sm text-gray-600">المبلغ المتبقي</div>
            <div class="text-2xl font-bold text-orange-600">{{ formatCurrency(paymentStats.remainingAmount) }}</div>
          </div>
        </div>
      </div>
      <div class="bg-gradient-to-r from-red-50 to-red-100 p-4 rounded-lg shadow-md border border-red-200">
        <div class="flex items-center">
          <div class="p-2 bg-red-500 rounded-lg">
            <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
            </svg>
          </div>
          <div class="mr-4">
            <div class="text-sm text-gray-600">المدفوعات المعلقة</div>
            <div class="text-2xl font-bold text-red-600">{{ paymentStats.pendingPayments }}</div>
          </div>
        </div>
      </div>
      </div>
      
      <!-- Quick Date Range Filters -->
      <div class="mt-4 flex flex-wrap items-center justify-between gap-2">
        <div class="flex flex-wrap gap-2">
          <span class="text-sm text-gray-600 font-medium">فترات سريعة:</span>
          <button 
            (click)="setQuickDateRange('today')" 
            class="text-xs bg-blue-100 hover:bg-blue-200 text-blue-700 px-2 py-1 rounded transition-colors">
            اليوم
          </button>
          <button 
            (click)="setQuickDateRange('thisWeek')" 
            class="text-xs bg-green-100 hover:bg-green-200 text-green-700 px-2 py-1 rounded transition-colors">
            هذا الأسبوع
          </button>
          <button 
            (click)="setQuickDateRange('thisMonth')" 
            class="text-xs bg-purple-100 hover:bg-purple-200 text-purple-700 px-2 py-1 rounded transition-colors">
            هذا الشهر
          </button>
          <button 
            (click)="setQuickDateRange('last30Days')" 
            class="text-xs bg-orange-100 hover:bg-orange-200 text-orange-700 px-2 py-1 rounded transition-colors">
            آخر 30 يوم
          </button>
          <button 
            (click)="setQuickDateRange('last90Days')" 
            class="text-xs bg-indigo-100 hover:bg-indigo-200 text-indigo-700 px-2 py-1 rounded transition-colors">
            آخر 90 يوم
          </button>
          <button 
            (click)="setQuickDateRange('thisYear')" 
            class="text-xs bg-teal-100 hover:bg-teal-200 text-teal-700 px-2 py-1 rounded transition-colors">
            هذا العام
          </button>
        </div>
        <button 
          (click)="clearFilters()" 
          class="text-sm bg-gray-100 hover:bg-gray-200 text-gray-700 px-3 py-1 rounded-md flex items-center gap-1 transition-colors">
          <i class="fas fa-refresh text-xs"></i>
          إعادة تعيين الفلاتر
        </button>
      </div>
    </div>
  </div>

  <!-- Filters Section -->
  <div class="bg-white p-4 rounded-lg shadow-sm border mb-6">
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4">
      <!-- Search -->
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">البحث</label>
        <input 
          type="text" 
          [(ngModel)]="searchTerm" 
          (ngModelChange)="applyFilters()"
          placeholder="البحث بالاسم أو الملاحظات"
          class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
      </div>

      <!-- Status Filter -->
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">حالة الدفع</label>
        <select 
          [(ngModel)]="statusFilter" 
          (ngModelChange)="applyFilters()"
          class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
          <option value="">جميع الحالات</option>
          <option [value]="PaymentStatus.Paid">مدفوع</option>
          <option [value]="PaymentStatus.Partial">مدفوع جزئياً</option>
          <option [value]="PaymentStatus.Unpaid">غير مدفوع</option>
        </select>
      </div>



      <!-- Date From -->
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">من تاريخ</label>
        <input 
          type="date" 
          [(ngModel)]="dateFromFilter" 
          (ngModelChange)="applyFilters()"
          class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
      </div>

      <!-- Date To -->
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">إلى تاريخ</label>
        <input 
          type="date" 
          [(ngModel)]="dateToFilter" 
          (ngModelChange)="applyFilters()"
          class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
      </div>

      <!-- Clear Filters -->
      <div class="flex items-end">
        <button 
          (click)="clearFilters()" 
          class="w-full bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-md transition-colors">
          مسح الفلاتر
        </button>
      </div>
    </div>
  </div>

  <!-- Messages -->
  <div *ngIf="message.text" class="mb-4">
    <div [class]="'p-4 rounded-md ' + (message.type === 'success' ? 'bg-green-100 text-green-700 border border-green-300' : 'bg-red-100 text-red-700 border border-red-300')">
      {{ message.text }}
    </div>
  </div>

  <!-- Loading Indicator -->
  <div *ngIf="isLoading" class="mb-4">
    <div class="bg-blue-50 border border-blue-200 p-4 rounded-md flex items-center justify-center">
      <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-blue-600 ml-3"></div>
      <span class="text-blue-700">جاري تحميل البيانات...</span>
    </div>
  </div>

  <!-- Payments Table -->
  <div class="bg-white rounded-lg shadow-sm border overflow-hidden">
    <div class="overflow-x-auto">
      <table class="min-w-full divide-y divide-gray-200">
        <thead class="bg-gray-50">
          <tr>
            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">المريض</th>
            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">نوع الدفعة</th>
            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">المبلغ الإجمالي</th>
            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">المبلغ المدفوع</th>
            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">المبلغ المتبقي</th>
            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">الخصم</th>
            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">حالة الدفع</th>
            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">تاريخ الدفع</th>
            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">الإجراءات</th>
          </tr>
        </thead>
        <tbody class="bg-white divide-y divide-gray-200">
          <!-- Loading State -->
          <tr *ngIf="isLoading">
            <td colspan="9" class="px-6 py-12 text-center">
              <div class="flex flex-col items-center justify-center">
                <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mb-4"></div>
                <p class="text-gray-500">جاري تحميل المدفوعات...</p>
              </div>
            </td>
          </tr>
          
          <!-- Empty State -->
          <tr *ngIf="!isLoading && paginatedPayments.length === 0">
            <td colspan="9" class="px-6 py-12 text-center">
              <div class="flex flex-col items-center justify-center">
                <i class="fas fa-receipt text-gray-300 text-4xl mb-4"></i>
                <p class="text-gray-500 text-lg mb-2">لا توجد مدفوعات</p>
                <p class="text-gray-400 text-sm">لم يتم العثور على أي مدفوعات تطابق المعايير المحددة</p>
              </div>
            </td>
          </tr>
          
          <!-- Data Rows -->
          <tr *ngFor="let payment of paginatedPayments" class="hover:bg-gray-50">
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
              {{ getPatientName(payment.patientId) }}
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">
              <span class="inline-flex px-2 py-1 text-xs font-medium rounded-full bg-gray-100 text-gray-800">
                {{ payment.appointmentId ? 'موعد' : (payment.treatmentPlanId ? 'خطة علاج' : 'عام') }}  
              </span>
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
              {{ formatCurrency(payment.totalAmount) }}
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-green-600 font-medium">
              {{ formatCurrency(payment.paidAmount) }}
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-red-600 font-medium">
              {{ formatCurrency(payment.remainingAmount) }}
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
              <span *ngIf="payment.discount > 0">
                {{ payment.discountType === DiscountType.Percentage ? payment.discount + '%' : formatCurrency(payment.discount) }}
              </span>
              <span *ngIf="payment.discount === 0" class="text-gray-400">لا يوجد</span>
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
              <span [class]="'inline-flex px-2 py-1 text-xs font-semibold rounded-full ' + getPaymentStatusBadgeClass(payment.paymentStatus)">
                {{ getPaymentStatusName(payment.paymentStatus) }}
              </span>
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
              {{ formatDate(payment.paymentDate) }}
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
              <div class="flex gap-2">
                <button 
                  (click)="openPaymentDetailsModal(payment)" 
                  class="text-blue-600 hover:text-blue-900 p-1 rounded" 
                  title="عرض التفاصيل">
                  <i class="fas fa-eye"></i>
                </button>
                <button 
                  (click)="openEditPaymentModal(payment)" 
                  class="text-yellow-600 hover:text-yellow-900 p-1 rounded" 
                  title="تعديل">
                  <i class="fas fa-edit"></i>
                </button>
                <button 
                  (click)="openTransactionModal(payment)" 
                  class="text-green-600 hover:text-green-900 p-1 rounded" 
                  title="إضافة معاملة">
                  <i class="fas fa-plus-circle"></i>
                </button>

                <button 
                  (click)="deletePayment(payment)" 
                  class="text-red-600 hover:text-red-900 p-1 rounded" 
                  title="حذف">
                  <i class="fas fa-trash"></i>
                </button>
              </div>
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <!-- Empty State -->
    <div *ngIf="filteredPayments.length === 0" class="text-center py-12">
      <i class="fas fa-credit-card text-gray-400 text-6xl mb-4"></i>
      <h3 class="text-lg font-medium text-gray-900 mb-2">لا توجد مدفوعات</h3>
      <p class="text-gray-500">لم يتم العثور على أي مدفوعات تطابق المعايير المحددة</p>
    </div>

    <!-- Pagination -->
    <div *ngIf="totalPages > 1" class="bg-white px-4 py-3 border-t border-gray-200 sm:px-6">
      <div class="flex items-center justify-between">
        <div class="flex-1 flex justify-between sm:hidden">
          <button 
            (click)="onPageChange(currentPage - 1)" 
            [disabled]="currentPage === 1"
            class="relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed">
            السابق
          </button>
          <button 
            (click)="onPageChange(currentPage + 1)" 
            [disabled]="currentPage === totalPages"
            class="ml-3 relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed">
            التالي
          </button>
        </div>
        <div class="hidden sm:flex-1 sm:flex sm:items-center sm:justify-between">
          <div>
            <p class="text-sm text-gray-700">
              عرض
              <span class="font-medium">{{ (currentPage - 1) * itemsPerPage + 1 }}</span>
              إلى
              <span class="font-medium">{{ getMinValue(currentPage * itemsPerPage, filteredPayments.length) }}</span>
              من
              <span class="font-medium">{{ filteredPayments.length }}</span>
              نتيجة
            </p>
          </div>
          <div>
            <nav class="relative z-0 inline-flex rounded-md shadow-sm -space-x-px" aria-label="Pagination">
              <button 
                (click)="onPageChange(currentPage - 1)" 
                [disabled]="currentPage === 1"
                class="relative inline-flex items-center px-2 py-2 rounded-r-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed">
                <i class="fas fa-chevron-right"></i>
              </button>
              <button 
                *ngFor="let page of pages" 
                (click)="onPageChange(page)"
                [class]="'relative inline-flex items-center px-4 py-2 border text-sm font-medium ' + 
                  (page === currentPage ? 
                    'z-10 bg-blue-50 border-blue-500 text-blue-600' : 
                    'bg-white border-gray-300 text-gray-500 hover:bg-gray-50')">
                {{ page }}
              </button>
              <button 
                (click)="onPageChange(currentPage + 1)" 
                [disabled]="currentPage === totalPages"
                class="relative inline-flex items-center px-2 py-2 rounded-l-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed">
                <i class="fas fa-chevron-left"></i>
              </button>
            </nav>
          </div>
        </div>
      </div>
    </div>
</div>

<!-- Analytics Modal -->
<div *ngIf="showAnalyticsModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
  <div class="relative top-20 mx-auto p-5 border w-11/12 md:w-3/4 lg:w-1/2 shadow-lg rounded-md bg-white">
    <div class="mt-3">
      <!-- Modal Header -->
      <div class="flex items-center justify-between pb-3 border-b">
        <h3 class="text-lg font-medium text-gray-900">تحليلات الدفعات</h3>
        <button (click)="closeAnalyticsModal()" class="text-gray-400 hover:text-gray-600">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
          </svg>
        </button>
      </div>

      <!-- Analytics Content -->
      <div class="mt-4">
        <!-- Period Selection -->
        <div class="mb-4">
          <label class="block text-sm font-medium text-gray-700 mb-2">فترة التحليل</label>
          <select [(ngModel)]="analyticsPeriod" (change)="loadAnalytics()" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
            <option value="daily">يومي</option>
            <option value="weekly">أسبوعي</option>
            <option value="monthly">شهري</option>
            <option value="yearly">سنوي</option>
          </select>
        </div>

        <!-- Date Range -->
        <div class="grid grid-cols-2 gap-4 mb-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">من تاريخ</label>
            <input type="date" [(ngModel)]="reportDateFrom" (change)="loadAnalytics()" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">إلى تاريخ</label>
            <input type="date" [(ngModel)]="reportDateTo" (change)="loadAnalytics()" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
          </div>
        </div>

        <!-- Analytics Data Display -->
        <div *ngIf="analyticsData" class="space-y-4">
          <div class="bg-gray-50 p-4 rounded-lg">
            <h4 class="font-medium text-gray-900 mb-2">ملخص التحليلات</h4>
            <div class="grid grid-cols-2 gap-4 text-sm">
              <div>إجمالي الدفعات: {{ analyticsData.totalPayments || 0 }}</div>
              <div>إجمالي المبلغ: {{ formatCurrency(analyticsData.totalAmount) }}</div>
              <div>المبلغ المدفوع: {{ formatCurrency(analyticsData.paidAmount) }}</div>
              <div>المبلغ المتبقي: {{ formatCurrency(analyticsData.remainingAmount) }}</div>
            </div>
          </div>
        </div>

        <!-- Loading State -->
        <div *ngIf="isLoading" class="text-center py-4">
          <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
          <p class="mt-2 text-gray-600">جاري تحميل التحليلات...</p>
        </div>
      </div>

      <!-- Modal Footer -->
      <div class="flex justify-end space-x-2 pt-4 border-t mt-4">
        <button (click)="closeAnalyticsModal()" class="px-4 py-2 bg-gray-300 text-gray-700 rounded-md hover:bg-gray-400 transition-colors">
          إغلاق
        </button>
        <button (click)="loadAnalytics()" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors">
          تحديث التحليلات
        </button>
      </div>
    </div>
  </div>
</div>

</div>

<!-- Export Modal -->
<div *ngIf="showExportModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
  <div class="relative top-20 mx-auto p-5 border w-11/12 md:w-1/2 lg:w-1/3 shadow-lg rounded-md bg-white">
    <div class="mt-3">
      <div class="flex justify-between items-center mb-4">
        <h3 class="text-lg font-medium text-gray-900">تصدير البيانات</h3>
        <button (click)="closeExportModal()" class="text-gray-400 hover:text-gray-600">
          <i class="fas fa-times"></i>
        </button>
      </div>

      <div class="mb-4">
        <label class="block text-sm font-medium text-gray-700 mb-2">تنسيق التصدير</label>
        <select [(ngModel)]="exportFormat" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
          <option value="excel">Excel (.xlsx)</option>
          <option value="pdf">PDF (.pdf)</option>
          <option value="csv">CSV (.csv)</option>
        </select>
      </div>

      <div class="mb-4 p-3 bg-blue-50 rounded-lg">
        <div class="text-sm text-blue-600">
          <i class="fas fa-info-circle mr-2"></i>
          سيتم تصدير {{ selectedPayments.size > 0 ? selectedPayments.size + ' دفعة محددة' : 'جميع الدفعات المفلترة' }}
        </div>
      </div>

      <div class="flex justify-end gap-3 mt-6">
        <button type="button" (click)="closeExportModal()" 
          class="px-4 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50">
          إلغاء
        </button>
        <button type="button" (click)="exportPayments()" 
          class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700">
          <i class="fas fa-download mr-2"></i>
          تصدير
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Create Payment Modal -->
<div *ngIf="showPaymentModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
  <div class="relative top-20 mx-auto p-5 border w-11/12 md:w-3/4 lg:w-1/2 shadow-lg rounded-md bg-white">
    <div class="mt-3">
      <div class="flex justify-between items-center mb-4">
        <h3 class="text-lg font-medium text-gray-900">إضافة دفعة جديدة</h3>
        <button (click)="closePaymentModal()" class="text-gray-400 hover:text-gray-600">
          <i class="fas fa-times"></i>
        </button>
      </div>

      <form [formGroup]="paymentForm" (ngSubmit)="createPayment()">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <!-- Patient Selection -->
          <div class="md:col-span-2 relative">
            <label class="block text-sm font-medium text-gray-700 mb-1">المريض *</label>
            
            <!-- Dropdown Trigger -->
            <div class="relative">
              <button type="button" 
                      (click)="toggleDropdown()" 
                      class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 text-right bg-white flex justify-between items-center">
                <span class="text-gray-500">{{ selectedPatient ? selectedPatient.fullName : 'اختر المريض' }}</span>
                <i class="fas fa-chevron-down text-gray-400"></i>
              </button>
            </div>

            <!-- Dropdown Content -->
            <div *ngIf="showPatientDropdown" class="absolute z-10 w-full mt-1 bg-white border border-gray-300 rounded-md shadow-lg">
              <!-- Search Box -->
              <div class="p-2 border-b">
                <input type="text" 
                       [(ngModel)]="patientSearchTerm" 
                       [ngModelOptions]="{standalone: true}"
                       (input)="onPatientSearchInput($event)"
                       (blur)="onPatientInputBlur()"
                       placeholder="ابحث عن المريض..."
                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 text-right">
              </div>
              
              <!-- Patient List -->
              <ul class="max-h-48 overflow-y-auto">
                <li *ngFor="let patient of filteredPatients" 
                    (mousedown)="selectPatient(patient)"
                    class="px-3 py-2 hover:bg-gray-100 cursor-pointer text-right">
                  <div class="font-medium">{{ patient.fullName }}</div>
                  <div class="text-sm text-gray-500">{{ patient.phoneNumber }}</div>
                </li>
                <li *ngIf="filteredPatients.length === 0" class="px-3 py-2 text-gray-500 text-right">
                  لا توجد نتائج
                </li>
              </ul>
            </div>

            <!-- Clear Selection Button -->
            <button *ngIf="selectedPatient" 
                    type="button" 
                    (click)="clearPatientSelection()" 
                    class="absolute left-2 top-8 text-gray-400 hover:text-gray-600">
              <i class="fas fa-times"></i>
            </button>
            
            <div *ngIf="paymentForm.get('patientId')?.invalid && paymentForm.get('patientId')?.touched" class="text-red-500 text-sm mt-1">
              يرجى اختيار المريض
            </div>
          </div>

          <!-- Total Amount -->
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">المبلغ الإجمالي *</label>
            <input type="number" formControlName="totalAmount" step="0.01" min="0" 
              [readonly]="isTotalAmountReadonly"
              [class]="'w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500' + (isTotalAmountReadonly ? ' bg-gray-100 cursor-not-allowed' : '')">
            <div *ngIf="paymentForm.get('totalAmount')?.invalid && paymentForm.get('totalAmount')?.touched" class="text-red-500 text-sm mt-1">
              يرجى إدخال مبلغ صحيح
            </div>
            <div *ngIf="isTotalAmountReadonly" class="text-blue-500 text-sm mt-1">
              المبلغ محمل تلقائياً من {{ paymentForm.get('paymentFor')?.value === PaymentFor.TreatmentPlan ? 'خطة العلاج' : 'الموعد' }}
            </div>
          </div>

          <!-- Discount Type -->
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">نوع الخصم</label>
            <select formControlName="discountType" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
              <option [value]="DiscountType.None">بدون خصم</option>
              <option [value]="DiscountType.Fixed">مبلغ ثابت</option>
              <option [value]="DiscountType.Percentage">نسبة مئوية</option>
            </select>
          </div>

          <!-- Discount -->
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">الخصم</label>
            <input type="number" formControlName="discount" step="0.01" min="0" 
              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 disabled:bg-gray-100 disabled:cursor-not-allowed">
          </div>

          <!-- Payment For -->
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">نوع الدفعة *</label>
            <select formControlName="paymentFor" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" (change)="onPaymentForChange()">
              <option [value]="PaymentFor.Appointment">موعد</option>
              <option [value]="PaymentFor.TreatmentPlan">خطة علاج</option>
            </select>
            <div *ngIf="paymentForm.get('paymentFor')?.invalid && paymentForm.get('paymentFor')?.touched" class="text-red-500 text-sm mt-1">
              يرجى اختيار نوع الدفعة
            </div>
          </div>

          <!-- Appointment Selection -->
          <div *ngIf="paymentForm.get('paymentFor')?.value === PaymentFor.Appointment">
            <label class="block text-sm font-medium text-gray-700 mb-1">اختر الموعد (المعلقة فقط)</label>
            <select formControlName="appointmentId" 
              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
              (change)="onAppointmentChange()">
              <option value="">اختر الموعد</option>
              <option *ngFor="let appointment of filteredAppointments" [value]="appointment.id">
                {{ appointment.appointmentDateTime | date:'dd/MM/yyyy HH:mm' }} - {{ appointment.serviceNames.join(', ') }}
              </option>
            </select>
            <div class="text-blue-500 text-xs mt-1">
              <i class="fas fa-info-circle"></i> يتم عرض المواعيد المعلقة فقط
            </div>
          </div>

          <!-- Treatment Plan Selection -->
          <div *ngIf="paymentForm.get('paymentFor')?.value === PaymentFor.TreatmentPlan">
            <label class="block text-sm font-medium text-gray-700 mb-1">اختر خطة العلاج (الغير مكتملة فقط)</label>
            <select formControlName="treatmentPlanId" 
              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
              (change)="onTreatmentPlanChange()">
              <option value="">اختر خطة العلاج</option>
              <option *ngFor="let plan of filteredTreatmentPlans" [value]="plan.id">
                {{ plan.description }} - {{ plan.estimatedCost | currency:'EGP':'symbol':'1.0-0':'ar' }} ج.م
              </option>
            </select>
            <div class="text-blue-500 text-xs mt-1">
              <i class="fas fa-info-circle"></i> يتم عرض خطط العلاج الغير مكتملة فقط
            </div>
          </div>

          <!-- Appointment Selection (for all payment types) -->
          <div *ngIf="paymentForm.get('paymentFor')?.value !== PaymentFor.Appointment && paymentForm.get('paymentFor')?.value !== PaymentFor.TreatmentPlan">
            <label class="block text-sm font-medium text-gray-700 mb-1">رقم الموعد (اختياري)</label>
            <select formControlName="appointmentId" 
              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
              <option value="">اختر الموعد</option>
              <option *ngFor="let appointment of filteredAppointments" [value]="appointment.id">
                {{ appointment.appointmentDateTime | date:'dd/MM/yyyy HH:mm' }} - {{ appointment.serviceNames.join(', ') }}
              </option>
            </select>
          </div>

          <!-- Notes -->
          <div class="md:col-span-2">
            <label class="block text-sm font-medium text-gray-700 mb-1">ملاحظات</label>
            <textarea formControlName="notes" rows="3" 
              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
          </div>

          <!-- Initial Transaction Section -->
          <div class="md:col-span-2 border-t pt-4">
            <div class="flex items-center mb-3">
              <input type="checkbox" formControlName="includeInitialTransaction" id="includeInitialTransaction" 
                class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
              <label for="includeInitialTransaction" class="mr-2 block text-sm text-gray-900">
                إضافة معاملة أولية
              </label>
            </div>

            <div *ngIf="paymentForm.get('includeInitialTransaction')?.value" class="grid grid-cols-1 md:grid-cols-3 gap-4">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">المبلغ المدفوع</label>
                <input type="number" formControlName="initialAmount" step="0.01" min="0" 
                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">طريقة الدفع</label>
                <select formControlName="initialMethod" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                  <option [value]="PaymentMethod.Cash">نقدي</option>
                  <option [value]="PaymentMethod.Card">بطاقة ائتمان</option>
                  <option [value]="PaymentMethod.BankTransfer">تحويل بنكي</option>
                  <option [value]="PaymentMethod.Installment">تقسيط</option>
                  <option [value]="PaymentMethod.Insurance">تأمين</option>
                </select>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">ملاحظات المعاملة</label>
                <input type="text" formControlName="initialNotes" 
                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
              </div>
            </div>
          </div>
        </div>

        <div class="flex justify-end gap-3 mt-6">
          <button type="button" (click)="closePaymentModal()" 
            class="px-4 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50">
            إلغاء
          </button>
          <button type="submit" [disabled]="paymentForm.invalid" 
            class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed">
            حفظ
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Reports Modal -->
<div *ngIf="showReportsModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
  <div class="relative top-10 mx-auto p-5 border w-11/12 md:w-5/6 lg:w-4/5 shadow-lg rounded-md bg-white max-h-screen overflow-y-auto">
    <div class="mt-3">
      <div class="flex justify-between items-center mb-4">
        <h3 class="text-lg font-medium text-gray-900">تقارير المدفوعات</h3>
        <button (click)="closeReportsModal()" class="text-gray-400 hover:text-gray-600">
          <i class="fas fa-times"></i>
        </button>
      </div>

      <!-- Date Range Selection -->
      <div class="bg-gray-50 p-4 rounded-lg mb-6">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-end">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">من تاريخ</label>
            <input type="date" [(ngModel)]="reportDateFrom" 
              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">إلى تاريخ</label>
            <input type="date" [(ngModel)]="reportDateTo" 
              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
          </div>
          <div>
            <button (click)="loadAllReports()" [disabled]="isLoading" 
              class="w-full bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md transition-colors disabled:opacity-50">
              <i class="fas fa-sync-alt" [class.fa-spin]="isLoading"></i>
              تحديث التقارير
            </button>
          </div>
        </div>
      </div>

      <!-- Loading State -->
      <div *ngIf="isLoading" class="text-center py-8">
        <i class="fas fa-spinner fa-spin text-3xl text-blue-600 mb-4"></i>
        <p class="text-gray-600">جاري تحميل التقارير...</p>
      </div>

      <!-- Reports Content -->
      <div *ngIf="!isLoading" class="space-y-6">
        <!-- Payment Summary -->
        <div *ngIf="paymentSummary" class="bg-white border rounded-lg p-4">
          <h4 class="text-lg font-semibold text-gray-800 mb-4">ملخص المدفوعات</h4>
          <div class="grid grid-cols-1 md:grid-cols-5 gap-4">
            <div class="bg-blue-50 p-3 rounded-lg">
              <div class="text-sm text-gray-600">إجمالي المبلغ</div>
              <div class="text-xl font-bold text-blue-600">{{ formatCurrency(paymentSummary.totalAmount) }}</div>
            </div>
            <div class="bg-green-50 p-3 rounded-lg">
              <div class="text-sm text-gray-600">المبلغ المدفوع</div>
              <div class="text-xl font-bold text-green-600">{{ formatCurrency(paymentSummary.paidAmount) }}</div>
            </div>
            <div class="bg-red-50 p-3 rounded-lg">
              <div class="text-sm text-gray-600">المبلغ المتبقي</div>
              <div class="text-xl font-bold text-red-600">{{ formatCurrency(paymentSummary.remainingAmount) }}</div>
            </div>
            <div class="bg-yellow-50 p-3 rounded-lg">
              <div class="text-sm text-gray-600">إجمالي الخصومات</div>
              <div class="text-xl font-bold text-yellow-600">{{ formatCurrency(paymentSummary.discounts) }}</div>
            </div>
            <div class="bg-purple-50 p-3 rounded-lg">
              <div class="text-sm text-gray-600">معدل التحصيل</div>
              <div class="text-xl font-bold text-purple-600">{{ paymentSummary.collectionRate.toFixed(1) }}%</div>
            </div>
          </div>
        </div>

        <!-- Revenue by Payment Method -->
        <div *ngIf="revenueByMethod.length > 0" class="bg-white border rounded-lg p-4">
          <h4 class="text-lg font-semibold text-gray-800 mb-4">الإيرادات حسب طريقة الدفع</h4>
          <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
              <thead class="bg-gray-50">
                <tr>
                  <th class="px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase">طريقة الدفع</th>
                  <th class="px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase">إجمالي الإيرادات</th>
                  <th class="px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase">النسبة المئوية</th>
                </tr>
              </thead>
              <tbody class="bg-white divide-y divide-gray-200">
                <tr *ngFor="let item of revenueByMethod">
                  <td class="px-4 py-2 text-sm text-gray-900">{{ getPaymentMethodName(item.method) }}</td>
                  <td class="px-4 py-2 text-sm font-medium text-green-600">{{ formatCurrency(item.totalRevenue) }}</td>
                  <td class="px-4 py-2 text-sm text-gray-600">{{ item.percentage.toFixed(1) }}%</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

        <!-- Payment Status Report -->
        <div *ngIf="paymentStatusReport.length > 0" class="bg-white border rounded-lg p-4">
          <h4 class="text-lg font-semibold text-gray-800 mb-4">تقرير حالة المدفوعات</h4>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div *ngFor="let status of paymentStatusReport" class="bg-gray-50 p-3 rounded-lg">
              <div class="text-sm text-gray-600">{{ status.status }}</div>
              <div class="text-xl font-bold text-gray-800">{{ status.count }}</div>
              <div class="text-sm text-gray-500">{{ status.percentage.toFixed(1) }}%</div>
            </div>
          </div>
        </div>

        <!-- Outstanding Payments -->
        <div *ngIf="outstandingPayments.length > 0" class="bg-white border rounded-lg p-4">
          <h4 class="text-lg font-semibold text-gray-800 mb-4">المدفوعات المعلقة</h4>
          <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
              <thead class="bg-gray-50">
                <tr>
                  <th class="px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase">المريض</th>
                  <th class="px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase">إجمالي المبلغ</th>
                  <th class="px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase">المبلغ المدفوع</th>
                  <th class="px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase">المبلغ المتبقي</th>
                  <th class="px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase">تاريخ الدفع</th>
                </tr>
              </thead>
              <tbody class="bg-white divide-y divide-gray-200">
                <tr *ngFor="let payment of outstandingPayments">
                  <td class="px-4 py-2 text-sm text-gray-900">{{ payment.patientName }}</td>
                  <td class="px-4 py-2 text-sm text-gray-900">{{ formatCurrency(payment.totalAmount) }}</td>
                  <td class="px-4 py-2 text-sm text-green-600">{{ formatCurrency(payment.paidAmount) }}</td>
                  <td class="px-4 py-2 text-sm font-medium text-red-600">{{ formatCurrency(payment.remaining) }}</td>
                  <td class="px-4 py-2 text-sm text-gray-600">{{ formatDate(payment.paymentDate) }}</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

        <!-- Payments by Patients -->
        <div *ngIf="paymentsByPatients.length > 0" class="bg-white border rounded-lg p-4">
          <h4 class="text-lg font-semibold text-gray-800 mb-4">المدفوعات حسب المرضى</h4>
          <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
              <thead class="bg-gray-50">
                <tr>
                  <th class="px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase">المريض</th>
                  <th class="px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase">عدد المدفوعات</th>
                  <th class="px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase">إجمالي المبلغ</th>
                  <th class="px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase">المبلغ المدفوع</th>
                  <th class="px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase">الخصم</th>
                  <th class="px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase">المتبقي</th>
                </tr>
              </thead>
              <tbody class="bg-white divide-y divide-gray-200">
                <tr *ngFor="let patient of paymentsByPatients">
                  <td class="px-4 py-2 text-sm text-gray-900">{{ patient.patientName }}</td>
                  <td class="px-4 py-2 text-sm text-gray-600">{{ patient.paymentsCount }}</td>
                  <td class="px-4 py-2 text-sm text-gray-900">{{ formatCurrency(patient.totalAmount) }}</td>
                  <td class="px-4 py-2 text-sm text-green-600">{{ formatCurrency(patient.paidAmount) }}</td>
                  <td class="px-4 py-2 text-sm text-yellow-600">{{ formatCurrency(patient.discount) }}</td>
                  <td class="px-4 py-2 text-sm text-red-600">{{ formatCurrency(patient.remaining) }}</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

        <!-- Transactions Report -->
        <div *ngIf="transactionsReport.length > 0" class="bg-white border rounded-lg p-4">
          <h4 class="text-lg font-semibold text-gray-800 mb-4">تقرير المعاملات</h4>
          <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
              <thead class="bg-gray-50">
                <tr>
                  <th class="px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase">تاريخ الدفع</th>
                  <th class="px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase">المبلغ</th>
                  <th class="px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase">طريقة الدفع</th>
                  <th class="px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase">ملاحظات</th>
                </tr>
              </thead>
              <tbody class="bg-white divide-y divide-gray-200">
                <tr *ngFor="let transaction of transactionsReport">
                  <td class="px-4 py-2 text-sm text-gray-900">{{ formatDate(transaction.paymentDate) }}</td>
                  <td class="px-4 py-2 text-sm font-medium text-green-600">{{ formatCurrency(transaction.amount) }}</td>
                  <td class="px-4 py-2 text-sm text-gray-600">{{ getPaymentMethodName(transaction.method) }}</td>
                  <td class="px-4 py-2 text-sm text-gray-500">{{ transaction.notes || 'لا توجد ملاحظات' }}</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Modal Footer -->
      <div class="flex justify-between mt-6 pt-4 border-t">
        <button (click)="exportReports()" [disabled]="isLoading || (!paymentSummary && revenueByMethod.length === 0 && paymentStatusReport.length === 0 && outstandingPayments.length === 0 && paymentsByPatients.length === 0 && transactionsReport.length === 0)"
          class="px-6 py-2 bg-green-600 hover:bg-green-700 text-white rounded-md transition-colors disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-2">
          <i class="fas fa-download"></i>
          تصدير التقارير
        </button>
        <button (click)="closeReportsModal()" 
          class="px-6 py-2 bg-gray-500 text-white rounded-md hover:bg-gray-600 transition-colors">
          إغلاق
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Edit Payment Modal -->
<div *ngIf="showEditPaymentModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
  <div class="relative top-10 mx-auto p-6 border w-11/12 md:w-4/5 lg:w-3/4 xl:w-2/3 shadow-lg rounded-lg bg-white max-h-[90vh] overflow-y-auto">
    <div class="mt-3">
      <!-- Header -->
      <div class="flex justify-between items-center mb-6 pb-4 border-b">
        <div>
          <h3 class="text-xl font-semibold text-gray-900">تعديل الدفعة</h3>
          <p class="text-sm text-gray-600 mt-1" *ngIf="selectedPayment">
            رقم الدفعة: #{{ selectedPayment.id }} | المريض: {{ getPatientName(selectedPayment.patientId) }}
          </p>
        </div>
        <button (click)="closeEditPaymentModal()" class="text-gray-400 hover:text-gray-600 p-2 rounded-full hover:bg-gray-100">
          <i class="fas fa-times text-lg"></i>
        </button>
      </div>

      <!-- Payment Summary Card -->
      <div *ngIf="selectedPayment" class="bg-gradient-to-r from-blue-50 to-indigo-50 rounded-lg p-4 mb-6 border border-blue-200">
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
          <div class="text-center">
            <p class="text-sm text-gray-600">الحالة</p>
            <span [class]="getPaymentStatusBadgeClass(selectedPayment.paymentStatus)" class="inline-block px-3 py-1 rounded-full text-xs font-medium mt-1">
              {{ getPaymentStatusName(selectedPayment.paymentStatus) }}
            </span>
          </div>
          <div class="text-center">
            <p class="text-sm text-gray-600">المبلغ المدفوع</p>
            <p class="text-lg font-semibold text-green-600">{{ formatCurrency(selectedPayment.paidAmount) }}</p>
          </div>
          <div class="text-center">
            <p class="text-sm text-gray-600">المبلغ المتبقي</p>
            <p class="text-lg font-semibold text-red-600">{{ formatCurrency(selectedPayment.remainingAmount) }}</p>
          </div>
          <div class="text-center">
            <p class="text-sm text-gray-600">تاريخ الدفعة</p>
            <p class="text-sm font-medium text-gray-800">{{ formatDate(selectedPayment.paymentDate) }}</p>
          </div>
        </div>
      </div>

      <!-- Edit Form -->
      <form [formGroup]="editPaymentForm" (ngSubmit)="updatePayment()">
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
          <!-- Left Column -->
          <div class="space-y-4">
            <h4 class="text-lg font-medium text-gray-900 border-b pb-2">معلومات الدفعة الأساسية</h4>
            
            <!-- Total Amount -->
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">
                <i class="fas fa-dollar-sign text-green-500 mr-2"></i>
                المبلغ الإجمالي *
              </label>
              <input type="number" formControlName="totalAmount" step="0.01" min="0" 
                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all">
              <div *ngIf="selectedPayment" class="text-xs text-gray-500 mt-1">
                المبلغ الحالي: {{ formatCurrency(selectedPayment.totalAmount) }}
              </div>
            </div>

            <!-- Discount Type -->
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">
                <i class="fas fa-percentage text-orange-500 mr-2"></i>
                نوع الخصم
              </label>
              <select formControlName="discountType" 
                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all">
                <option [value]="DiscountType.None">بدون خصم</option>
                <option [value]="DiscountType.Fixed">مبلغ ثابت</option>
                <option [value]="DiscountType.Percentage">نسبة مئوية</option>
              </select>
            </div>

            <!-- Discount -->
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">
                <i class="fas fa-tag text-red-500 mr-2"></i>
                قيمة الخصم
              </label>
              <input type="number" formControlName="discount" step="0.01" min="0" 
                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all disabled:bg-gray-100 disabled:cursor-not-allowed">
              <div *ngIf="selectedPayment && selectedPayment.discount > 0" class="text-xs text-gray-500 mt-1">
                الخصم الحالي: {{ formatCurrency(selectedPayment.discount) }}
              </div>
            </div>
          </div>

          <!-- Right Column -->
          <div class="space-y-4">
            <h4 class="text-lg font-medium text-gray-900 border-b pb-2">معلومات الربط</h4>
            
            <!-- Payment For Info -->
            <div *ngIf="selectedPayment" class="bg-gray-50 rounded-lg p-3">
              <p class="text-sm font-medium text-gray-700 mb-1">
                <i class="fas fa-link text-blue-500 mr-2"></i>
                مرتبط بـ: {{ getPaymentForName(selectedPayment.paymentFor) }}
              </p>
              <div *ngIf="selectedPayment.appointmentId" class="text-xs text-gray-600">
                رقم الموعد: {{ selectedPayment.appointmentId }}
              </div>
              <div *ngIf="selectedPayment.treatmentPlanId" class="text-xs text-gray-600">
                رقم خطة العلاج: {{ selectedPayment.treatmentPlanId }}
              </div>
            </div>

            <!-- Appointment ID -->
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">
                <i class="fas fa-calendar-check text-blue-500 mr-2"></i>
                رقم الموعد
              </label>
              <input type="number" formControlName="appointmentId" [disabled]="true"
                class="w-full px-4 py-3 border border-gray-300 rounded-lg bg-gray-100 cursor-not-allowed text-gray-500">
              <p class="text-xs text-red-500 mt-1">لا يمكن تعديل رقم الموعد المرتبط بالدفعة</p>
            </div>

            <!-- Treatment Plan ID -->
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">
                <i class="fas fa-clipboard-list text-purple-500 mr-2"></i>
                رقم خطة العلاج
              </label>
              <input type="number" formControlName="treatmentPlanId" [disabled]="true"
                class="w-full px-4 py-3 border border-gray-300 rounded-lg bg-gray-100 cursor-not-allowed text-gray-500">
              <p class="text-xs text-red-500 mt-1">لا يمكن تعديل رقم خطة العلاج المرتبطة بالدفعة</p>
            </div>
          </div>
        </div>

        <!-- Notes Section -->
        <div class="mt-6">
          <label class="block text-sm font-medium text-gray-700 mb-2">
            <i class="fas fa-sticky-note text-yellow-500 mr-2"></i>
            ملاحظات
          </label>
          <textarea formControlName="notes" rows="4" 
            placeholder="أضف أي ملاحظات إضافية حول هذه الدفعة..."
            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all resize-none"></textarea>
        </div>

        <!-- Transactions Summary -->
        <div *ngIf="selectedPayment && selectedPayment.transactions && selectedPayment.transactions.length > 0" class="mt-6">
          <h4 class="text-lg font-medium text-gray-900 mb-3">
            <i class="fas fa-list text-indigo-500 mr-2"></i>
            المعاملات المرتبطة ({{ selectedPayment.transactions.length }})
          </h4>
          <div class="bg-gray-50 rounded-lg p-4 max-h-40 overflow-y-auto">
            <div *ngFor="let transaction of selectedPayment.transactions; let i = index" 
              class="flex justify-between items-center py-2 border-b border-gray-200 last:border-b-0">
              <div class="flex items-center space-x-3 space-x-reverse">
                <span class="bg-blue-100 text-blue-800 text-xs px-2 py-1 rounded-full">{{ i + 1 }}</span>
                <div>
                  <p class="text-sm font-medium text-gray-900">{{ formatCurrency(transaction.amount) }}</p>
                  <p class="text-xs text-gray-500">{{ getPaymentMethodName(transaction.method) }} - {{ formatDate(transaction.paymentDate) }}</p>
                </div>
              </div>
              <div *ngIf="transaction.notes" class="text-xs text-gray-600 max-w-32 truncate" [title]="transaction.notes">
                {{ transaction.notes }}
              </div>
            </div>
          </div>
        </div>

        <!-- Action Buttons -->
        <div class="flex justify-end gap-3 mt-8 pt-4 border-t">
          <button type="button" (click)="closeEditPaymentModal()" 
            class="px-6 py-3 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 transition-colors font-medium">
            <i class="fas fa-times mr-2"></i>
            إلغاء
          </button>
          <button type="submit" [disabled]="editPaymentForm.invalid" 
            class="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed transition-colors font-medium">
            <i class="fas fa-save mr-2"></i>
            حفظ التغييرات
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Payment Details Modal -->
<div *ngIf="showPaymentDetailsModal && selectedPayment" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
  <div class="relative top-10 mx-auto p-5 border w-11/12 md:w-4/5 lg:w-3/4 shadow-lg rounded-md bg-white">
    <div class="mt-3">
      <div class="flex justify-between items-center mb-4">
        <h3 class="text-lg font-medium text-gray-900">تفاصيل الدفعة</h3>
        <button (click)="closePaymentDetailsModal()" class="text-gray-400 hover:text-gray-600">
          <i class="fas fa-times"></i>
        </button>
      </div>

      <!-- Payment Information -->
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-6">
        <div class="bg-gray-50 p-4 rounded-lg">
          <div class="text-sm text-gray-600">المريض</div>
          <div class="font-medium">{{ getPatientName(selectedPayment.patientId) }}</div>
        </div>
        <div class="bg-gray-50 p-4 rounded-lg">
          <div class="text-sm text-gray-600">المبلغ الإجمالي</div>
          <div class="font-medium text-blue-600">{{ formatCurrency(selectedPayment.totalAmount) }}</div>
        </div>
        <div class="bg-gray-50 p-4 rounded-lg">
          <div class="text-sm text-gray-600">المبلغ المدفوع</div>
          <div class="font-medium text-green-600">{{ formatCurrency(selectedPayment.paidAmount) }}</div>
        </div>
        <div class="bg-gray-50 p-4 rounded-lg">
          <div class="text-sm text-gray-600">المبلغ المتبقي</div>
          <div class="font-medium text-red-600">{{ formatCurrency(selectedPayment.remainingAmount) }}</div>
        </div>
        <div class="bg-gray-50 p-4 rounded-lg">
          <div class="text-sm text-gray-600">الخصم</div>
          <div class="font-medium">
            <span *ngIf="selectedPayment.discount > 0">
              {{ selectedPayment.discountType === DiscountType.Percentage ? selectedPayment.discount + '%' : formatCurrency(selectedPayment.discount) }}
              ({{ getDiscountTypeName(selectedPayment.discountType) }})
            </span>
            <span *ngIf="selectedPayment.discount === 0" class="text-gray-400">لا يوجد</span>
          </div>
        </div>
        <div class="bg-gray-50 p-4 rounded-lg">
          <div class="text-sm text-gray-600">حالة الدفع</div>
          <span [class]="'inline-flex px-2 py-1 text-xs font-semibold rounded-full ' + getPaymentStatusBadgeClass(selectedPayment.paymentStatus)">
            {{ getPaymentStatusName(selectedPayment.paymentStatus) }}
          </span>
        </div>
        <div class="bg-gray-50 p-4 rounded-lg">
          <div class="text-sm text-gray-600">نوع الدفع</div>
          <div class="font-medium">{{ getPaymentForName(selectedPayment.paymentFor) }}</div>
        </div>
        <div class="bg-gray-50 p-4 rounded-lg">
          <div class="text-sm text-gray-600">تاريخ الدفع</div>
          <div class="font-medium">{{ formatDate(selectedPayment.paymentDate) }}</div>
        </div>
        <div *ngIf="selectedPayment.dentalServiceId" class="bg-gray-50 p-4 rounded-lg">
          <div class="text-sm text-gray-600">معرف الخدمة السنية</div>
          <div class="font-medium">{{ selectedPayment.dentalServiceId }}</div>
        </div>
        <div *ngIf="selectedPayment.appointmentId" class="bg-gray-50 p-4 rounded-lg">
          <div class="text-sm text-gray-600">معرف الموعد</div>
          <div class="font-medium">{{ selectedPayment.appointmentId }}</div>
        </div>
        <div *ngIf="selectedPayment.treatmentPlanId" class="bg-gray-50 p-4 rounded-lg">
          <div class="text-sm text-gray-600">معرف خطة العلاج</div>
          <div class="font-medium">{{ selectedPayment.treatmentPlanId }}</div>
        </div>
      </div>

      <!-- Notes -->
      <div *ngIf="selectedPayment.notes" class="mb-6">
        <div class="bg-gray-50 p-4 rounded-lg">
          <div class="text-sm text-gray-600 mb-2">ملاحظات</div>
          <div class="text-gray-900">{{ selectedPayment.notes }}</div>
        </div>
      </div>

      <!-- Transactions -->
      <div class="mb-4">
        <div class="flex justify-between items-center mb-4">
          <h4 class="text-lg font-medium text-gray-900">المعاملات</h4>
          <button 
            (click)="openTransactionModal(selectedPayment)" 
            class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg flex items-center gap-2">
            <i class="fas fa-plus"></i>
            إضافة معاملة
          </button>
        </div>

        <div class="overflow-x-auto">
          <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
              <tr>
                <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">المبلغ</th>
                <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">طريقة الدفع</th>
                <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">تاريخ الدفع</th>
                <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">ملاحظات</th>
                <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">الإجراءات</th>
              </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200">
              <tr *ngFor="let transaction of selectedPaymentTransactions">
                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-green-600">
                  {{ formatCurrency(transaction.amount) }}
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                  {{ getPaymentMethodName(transaction.method) }}
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                  {{ formatDate(transaction.paymentDate) }}
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                  {{ transaction.notes || '-' }}
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                  <button 
                    (click)="deleteTransaction(transaction)" 
                    class="text-red-600 hover:text-red-900 p-1 rounded" 
                    title="حذف">
                    <i class="fas fa-trash"></i>
                  </button>
                </td>
              </tr>
            </tbody>
          </table>
        </div>

        <div *ngIf="selectedPaymentTransactions.length === 0" class="text-center py-8">
          <i class="fas fa-receipt text-gray-400 text-4xl mb-2"></i>
          <p class="text-gray-500">لا توجد معاملات لهذه الدفعة</p>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Add Transaction Modal -->
<div *ngIf="showTransactionModal && selectedPayment" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
  <div class="relative top-20 mx-auto p-5 border w-11/12 md:w-1/2 lg:w-1/3 shadow-lg rounded-md bg-white">
    <div class="mt-3">
      <div class="flex justify-between items-center mb-4">
        <h3 class="text-lg font-medium text-gray-900">إضافة معاملة جديدة</h3>
        <button (click)="closeTransactionModal()" class="text-gray-400 hover:text-gray-600">
          <i class="fas fa-times"></i>
        </button>
      </div>

      <div class="mb-4 p-3 bg-blue-50 rounded-lg">
        <div class="text-sm text-blue-600">المريض: {{ getPatientName(selectedPayment.patientId) }}</div>
        <div class="text-sm text-blue-600">المبلغ المتبقي: {{ formatCurrency(selectedPayment.remainingAmount) }}</div>
      </div>

      <div *ngIf="transactionMessage.text" class="mb-4">
        <div [class]="'p-3 rounded-md text-sm ' + (transactionMessage.type === 'success' ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700')">
          {{ transactionMessage.text }}
        </div>
      </div>

      <form [formGroup]="transactionForm" (ngSubmit)="addTransaction()">
        <div class="space-y-4">
          <!-- Amount -->
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">المبلغ *</label>
            <input type="number" formControlName="amount" step="0.01" min="0.01" 
              [max]="selectedPayment.remainingAmount"
              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
            <div *ngIf="transactionForm.get('amount')?.invalid && transactionForm.get('amount')?.touched" class="text-red-500 text-sm mt-1">
              يرجى إدخال مبلغ صحيح
            </div>
          </div>

          <!-- Payment Method -->
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">طريقة الدفع *</label>
            <select formControlName="method" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
              <option [value]="PaymentMethod.Cash">نقدي</option>
              <option [value]="PaymentMethod.Card">بطاقة ائتمان</option>
              <option [value]="PaymentMethod.BankTransfer">تحويل بنكي</option>
              <option [value]="PaymentMethod.Installment">تقسيط</option>
              <option [value]="PaymentMethod.Insurance">تأمين</option>
            </select>
          </div>

          <!-- Payment Date -->
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">تاريخ الدفع *</label>
            <input type="date" formControlName="paymentDate" 
              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
          </div>

          <!-- Notes -->
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">ملاحظات</label>
            <textarea formControlName="notes" rows="3" 
              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
          </div>
        </div>

        <div class="flex justify-end gap-3 mt-6">
          <button type="button" (click)="closeTransactionModal()" 
            class="px-4 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50">
            إلغاء
          </button>
          <button type="submit" [disabled]="transactionForm.invalid" 
            class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 disabled:opacity-50 disabled:cursor-not-allowed">
            إضافة المعاملة
          </button>
        </div>
      </form>
    </div>
  </div>
</div>